# Research: Pass Validation & Scanning

## 1. Cryptographically Signed Token (JWT) for QR Payload
**Decision**: Use a custom HMAC signed payload: `base64_encode($passId . '.' . hash_hmac('sha256', $passId, config('app.key')))`.
**Rationale**: Keeps the QR code payload extremely small (better scanning reliability on low-end devices) while ensuring it cannot be forged or enumerated. Laravel's `Crypt` facade produces much longer strings, and a full JWT is overkill since we only need to verify the payload was generated by our server.
**Alternatives considered**: Full JWT (larger payload), Laravel `Crypt` (larger payload).

## 2. Scanner URL / Token Authentication
**Decision**: Create a `ScannerLink` model/table that belongs to a `Tenant` or `Location`. It generates a unique, cryptographically secure token (e.g., `Str::random(40)`). The web scanner interface is accessed via `/scanner/{token}`. We will use a custom route middleware `ValidateScannerToken` that authenticates the session or request based on this token, setting a scoped "Scanner" context in the application without logging in a full `User` model.
**Rationale**: Meets the requirement for a long-lived URL without requiring staff to have full user accounts or go through a login flow.
**Alternatives considered**: Laravel Sanctum personal access tokens (requires a user model), standard session login (violates requirement).

## 3. Concurrency Controls for Single-Use Passes
**Decision**: Use Laravel's pessimistic locking (`lockForUpdate()`) within a database transaction when redeeming a single-use pass.
```php
DB::transaction(function () use ($passId) {
    $pass = Pass::where('id', $passId)->lockForUpdate()->firstOrFail();
    if ($pass->is_redeemed) {
        throw new AlreadyRedeemedException();
    }
    $pass->markAsRedeemed();
});
```
**Rationale**: Standard, robust way to prevent race conditions and double-redemptions in relational databases.
**Alternatives considered**: Redis locks (adds dependency, DB lock is sufficient and transactional), Optimistic locking (requires version column, pessimistic is safer for redemptions).
